version: '3'

services:

  vnc: &vnc
    image: f1tenth-riders-vnc
    build:
      context: .
      dockerfile: compose/vnc/Dockerfile
      args: 
        - PARENT=ros:melodic-robot-bionic
        - ROS_DISTRO=melodic
  
  vnc-dev:
    <<: *vnc
    stdin_open: true
    tty: true
    ports: 
      - "6080:6080"

  roscore: &roscore
    image: f1tenth-riders-roscore
    build: 
      context: compose/roscore
      args: 
        - PARENT=f1tenth-riders-vnc
  
  roscore-dev:
    <<: *roscore
    volumes: 
      - ./compose/roscore/start.sh:/start.sh
    stdin_open: true
    ports:
      # expose ROSCORE port to Out
      - 11311:11311

  rviz:
    <<: *roscore
    volumes:
      - ./compose/rviz/start.sh:/start.sh
      - ./compose/rviz/f1tenth.rviz:/f1tenth.rviz
    ports:
      # expose NoVNC port to Out
      - 6080:6080
    environment:
      - ROS_MASTER_URI=http://host.docker.internal:11311

  bridge: &bridge
    image: f1tenth-riders-bridge
    build:
      context: .
      dockerfile: compose/bridge/Dockerfile
      args: 
        - PARENT=f1tenth-riders-vnc

  bridge-dev:
    <<: *bridge
    stdin_open: true
    ports:
      - 6081:6081
    volumes:
      - ./compose/bridge/start.sh:/start.sh
    environment: 
      - ROS_MASTER_URI=http://host.docker.internal:11311
      - RACE_MAP_PATH=${RACE_MAP_PATH}
      - RACE_MAP_IMG_EXT=${RACE_MAP_IMG_EXT}
      # Scenario: 0 for single car timed trial (qualifying), 1 for dual car racing (grand prix)
      - RACE_SCENARIO=0
      - EGO_ID=icart_id
      # - OPP_ID=opp_id
      # Starting pose for both of the cars, also a map parameter
      - EGO_STARTING_X=0.0
      - EGO_STARTING_Y=0.0
      - EGO_STARTING_THETA=-0.5
      - OPP_STARTING_X=0.0
      - OPP_STARTING_Y=2.0
      - OPP_STARTING_THETA=-0.5
      # the executable path of the C++ backend of gym, should NOT be changed unless you know what you're doing
      - F1TENTH_EXEC_DIR=/f1tenth_gym/build/

  agent: &agent
    image: f1tenth-riders-agent
    build:
      context: .
      dockerfile: compose/agent/Dockerfile
      args:
        - PARENT=f1tenth-riders-roscore

  agent-dev:
    <<: *agent
    environment:
      - ROS_MASTER_URI=http://host.docker.internal:11311
      - F1TENTH_AGENT_NAME=icart_id
    volumes:
      - ./pkg:/catkin_ws/src/pkg